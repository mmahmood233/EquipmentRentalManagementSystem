@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var req = ViewBag.RequestStats;
    var equip = ViewBag.EquipmentStats;
    var finance = ViewBag.FinanceStats;
    var logs = ViewBag.RecentLogs as List<ProjectDBClassLibrary.Model.Log>;
    var categories = ViewBag.CategoryData;
    var feeStats = ViewBag.FeeStats;
}

<div class="container py-4">
    <h2 class="fw-bold text-primary mb-4"> Admin Dashboard</h2>

    <div class="row g-4 mb-4">
        <div class="col-md-3"><div class="card p-3 shadow-sm"><strong>Total Requests:</strong> @req.totalRequests</div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm text-warning"><strong>Pending:</strong> @req.pendingRequests</div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm text-success"><strong>Approved:</strong> @req.approvedRequests</div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm text-danger"><strong>Denied:</strong> @req.deniedRequests</div></div>
        <div class="col-md-3"><div class="card p-3 shadow-sm text-danger"><strong>Overdue:</strong> @req.overdueRequests</div></div>
    </div>

    <h5 class="mt-4 mb-2"> Requests by Category</h5>
    <ul class="list-group mb-4">
        @foreach (var c in (IEnumerable<dynamic>)categories)
        {
                <li class="list-group-item d-flex justify-content-between">
                    <span>@c.Category</span>
                    <span class="badge bg-primary rounded-pill">@c.Count</span>
                </li>
        }
    </ul>

    <div class="row g-4 mb-4">
        <div class="col-md-4"><div class="card p-3 shadow-sm"><strong>Damaged Equipment:</strong> @equip.damagedEquipment</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm text-success"><strong>Available:</strong> @equip.availableEquipment</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm text-danger"><strong>Unavailable:</strong> @equip.unavailableEquipment</div></div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6"><div class="card p-3 shadow-sm"><strong>Total Rental Income:</strong> @finance.totalIncome.ToString("C")</div></div>
        <div class="col-md-6"><div class="card p-3 shadow-sm text-warning"><strong>Pending Payments:</strong> @finance.totalPending.ToString("C")</div></div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4"><div class="card p-3 shadow-sm"><strong>Total Late Return Fees:</strong> @feeStats.totalLateFees.ToString("C")</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm"><strong>Total Extra Charges:</strong> @feeStats.totalExtraFees.ToString("C")</div></div>
        <div class="col-md-4"><div class="card p-3 shadow-sm text-info"><strong>Total Return Revenue:</strong> @feeStats.totalReturnRevenue.ToString("C")</div></div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h6> Request Status Distribution</h6>
                <canvas id="requestStatusChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h6> Equipment Condition Distribution</h6>
                <canvas id="equipmentConditionChart"></canvas>
            </div>
        </div>
        <div class="col-md-12">
            <div class="card p-3 shadow-sm">
                <h6> Requests per Category</h6>
                <canvas id="requestsByCategoryChart"></canvas>
            </div>
        </div>
    </div>

    <h5 class="mt-4 mb-2"> Recent Logs</h5>
    <table class="table table-bordered table-hover shadow-sm">
        <thead class="table-light">
            <tr><th>User</th><th>Action</th><th>Source</th><th>Date</th></tr>
        </thead>
        <tbody>
            @foreach (var log in logs)
            {
                    <tr>
                        <td>@log.User?.Fullname</td>
                        <td>@log.Action</td>
                        <td>@log.Source</td>
                        <td>@log.TimeStamp.ToString("yyyy-MM-dd HH:mm")</td>
                    </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            new Chart(document.getElementById('requestStatusChart'), {
                type: 'pie',
                data: {
                    labels: ['Pending', 'Approved', 'Denied'],
                    datasets: [{
                        label: 'Request Status',
                        data: [@req.pendingRequests, @req.approvedRequests, @req.deniedRequests],
                        backgroundColor: ['#f0ad4e', '#5cb85c', '#d9534f']
                    }]
                }
            });

            new Chart(document.getElementById('equipmentConditionChart'), {
                type: 'pie',
                data: {
                    labels: ['Available', 'Unavailable', 'Damaged'],
                    datasets: [{
                        label: 'Equipment Condition',
                        data: [@equip.availableEquipment, @equip.unavailableEquipment, @equip.damagedEquipment],
                        backgroundColor: ['#5cb85c', '#d9534f', '#f0ad4e']
                    }]
                }
            });

            const categoryData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.CategoryData));
            const categoryLabels = categoryData.map(c => c.Category);
            const categoryCounts = categoryData.map(c => c.Count);

            new Chart(document.getElementById('requestsByCategoryChart'), {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'Requests per Category',
                        data: categoryCounts,
                        backgroundColor: '#4a90e2'
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        </script>
}
