@using Microsoft.AspNetCore.Identity
@inject UserManager<AdvancedProgrammingASPProject.Areas.Identity.Data.Users> UserManager

@model IEnumerable<ProjectDBClassLibrary.Model.RentalRequest>
@if (TempData["Error"] != null)
{
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
}


@{
    ViewData["Title"] = "Rental Requests";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var customerFilterValue = Context.Request.Query["customerFilter"].ToString();
    var statusFilterValue = Context.Request.Query["statusFilter"].ToString();
    var searchIdValue = Context.Request.Query["searchId"].ToString();
    var user = Context.User;
    var dbContext = Context.RequestServices.GetService(typeof(ProjectDBClassLibrary.Model.ProjectDBContext)) as ProjectDBClassLibrary.Model.ProjectDBContext;
    var identityDb = UserManager;
    var isAdminOrManager = false;
    var isCustomer = false;
    int mainUserId = 0;

    if (user.Identity.IsAuthenticated && dbContext != null && identityDb != null)
    {
        var identityUser = await identityDb.GetUserAsync(user);
        if (identityUser?.MainUserId != null)
        {
            mainUserId = identityUser.MainUserId.Value;
            var mainUser = dbContext.Users.FirstOrDefault(u => u.UserId == mainUserId);
            if (mainUser != null)
            {
                isAdminOrManager = mainUser.RoleId == 1 || mainUser.RoleId == 3;
                isCustomer = mainUser.RoleId == 2;
            }
        }
    }

    var pendingRequests = ViewBag.PendingRequests as List<ProjectDBClassLibrary.Model.RentalRequest> ?? new List<ProjectDBClassLibrary.Model.RentalRequest>();
}

<style>
    .badge-status {
        font-size: 0.85rem;
        padding: 0.4em 0.6em;
    }
    .card-title {
        font-size: 1.3rem;
        font-weight: bold;
        color: #4a90e2;
    }
    .info-label {
        font-weight: 500;
        color: #444;
    }
    .card {
        background-color: #fff !important;
        border-radius: 0.75rem;
        transition: 0.3s ease-in-out;
    }
    .card:hover {
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .card-footer {
        background-color: transparent;
        border-top: none;
    }

    .bg-light-blue {
        background-color: #e7f1ff !important;
    }

    .bg-light-red {
        background-color: #ffe7e7 !important;
    }
}

</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-primary">Rental Requests</h2>
    </div>

    <form asp-controller="RentalRequests" asp-action="Index" method="get" class="bg-white p-4 rounded border shadow-sm mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label fw-semibold">Customer</label>
                <select name="customerFilter" class="form-select" asp-items="ViewBag.CustomerFilter">
                    <option value=""> All Customers </option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Request Status</label>
                <select name="statusFilter" class="form-select" asp-items="ViewBag.StatusFilter">
                    <option value=""> All Status </option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-semibold">Request ID</label>
                <input type="number" name="searchId" class="form-control" value="@searchIdValue" placeholder="Enter ID" />
            </div>

            <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Apply Filters
                </button>
            </div>
        </div>
    </form>

    @if (!Model.Any() && pendingRequests.Count == 0)
    {
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No rental requests found matching your criteria.
            </div>
    }
    else if (isAdminOrManager)
    {
        if (pendingRequests.Any())
        {
                    <h4 class="text-success">Pending Requests</h4>
                    <div class="row g-4 mb-5">
                @foreach (var item in pendingRequests)
                {
                                <partial name="_RentalRequestCard" model="item" />
                }
                    </div>
        }

        if (Model.Any())
        {
                    <h4 class="text-secondary">Processed Requests (Approved / Denied)</h4>
                    <div class="row g-4">
                @foreach (var item in Model)
                {
                                <partial name="_RentalRequestCard" model="item" />
                }
                    </div>
        }
    }
    else if (isCustomer)
    {
            <div class="row g-4">
            @foreach (var item in Model.Where(m => m.UserId == mainUserId))
            {
                               <div class="col-md-6">
            <div class="card shadow-sm h-100 @(item.Status == "Pending" ? "bg-light-blue" : "")">

                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h5 class="card-title text-primary mb-0">@item.Equipment?.Name</h5>
                                        <small class="text-muted">@item.CreatedAt.ToShortDateString()</small>
                                    </div>

                                    <div class="row">
                                        <div class="col-6">
                                            <p class="mb-1"><span class="fw-semibold">Total Cost:</span> @item.TotalCost.ToString("C")</p>
                                            <p class="mb-1">
                                                <span class="fw-semibold">Status:</span>
                                        @if (item.Status == "Pending")
                                        {
                                                        <span class="badge bg-warning text-dark">Pending</span>
                                        }
                                        else if (item.Status == "Approved")
                                        {
                                                        <span class="badge bg-primary">Approved</span>
                                        }
                                        else
                                        {
                                                        <span class="badge bg-secondary">@item.Status</span>
                                        }
                                            </p>
                                        </div>
                                        <div class="col-6">
                                            <p class="mb-1"><span class="fw-semibold">Start:</span> @item.StartDate.ToShortDateString()</p>
                                            <p class="mb-1"><span class="fw-semibold">Return:</span> @item.ReturnDate.ToShortDateString()</p>
                                        </div>
                                    </div>

                            @if (item.Status == "Pending")
                            {
                                            <div class="text-end mt-3">
                                                <a asp-controller="RentalRequests" asp-action="Edit" asp-route-id="@item.RentalRequestId" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-pencil-square"></i> Update
                                                </a>
                                            </div>
                            }
                                </div>
                            </div>
                        </div>
            }
            </div>
    }
    else
    {
            <div class="alert alert-warning text-center">
                Please <a href="/Identity/Account/Login">login</a> to view your rental requests.
            </div>
    }
</div>

@if (ViewBag.TotalPages > 1)
{
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(ViewBag.CurrentPage - 1)"
                       asp-route-customerFilter="@Context.Request.Query["customerFilter"]"
                       asp-route-statusFilter="@Context.Request.Query["statusFilter"]"
                       asp-route-searchId="@Context.Request.Query["searchId"]">
                        Previous
                    </a>
                </li>

            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-page="@i"
                               asp-route-customerFilter="@Context.Request.Query["customerFilter"]"
                               asp-route-statusFilter="@Context.Request.Query["statusFilter"]"
                               asp-route-searchId="@Context.Request.Query["searchId"]">
                        @i
                            </a>
                        </li>
            }

                <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-page="@(ViewBag.CurrentPage + 1)"
                       asp-route-customerFilter="@Context.Request.Query["customerFilter"]"
                       asp-route-statusFilter="@Context.Request.Query["statusFilter"]"
                       asp-route-searchId="@Context.Request.Query["searchId"]">
                        Next
                    </a>
                </li>
            </ul>
        </nav>
}